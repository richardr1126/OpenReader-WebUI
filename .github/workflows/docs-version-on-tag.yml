name: Docs Version on Tag

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pull-requests: write

jobs:
  version-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: docs-site/pnpm-lock.yaml

      - name: Install docs dependencies
        run: pnpm --dir docs-site install --frozen-lockfile

      - name: Snapshot docs version
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [ -f docs-site/versions.json ] && grep -q "\"${VERSION}\"" docs-site/versions.json; then
            echo "Version ${VERSION} already exists in versions.json; skipping docs:version"
          else
            pnpm --dir docs-site docusaurus docs:version "${VERSION}"
          fi

      - name: Set default docs version
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          node -e "const fs=require('fs'); const file='docs-site/docusaurus.config.ts'; const source=fs.readFileSync(file,'utf8'); const updated=source.replace(/lastVersion:\s*'[^']*',/, \"lastVersion: '\" + process.env.VERSION + \"',\"); if (source===updated) { throw new Error('Unable to update lastVersion in docusaurus.config.ts'); } fs.writeFileSync(file, updated);"

      - name: Build docs
        run: pnpm --dir docs-site build

      - name: Create docs version PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: docs: snapshot ${{ github.ref_name }}
          title: docs: snapshot ${{ github.ref_name }}
          body: |
            Automated docs version snapshot for `${{ github.ref_name }}`.

            - Ran `docusaurus docs:version`
            - Updated `lastVersion` in `docs-site/docusaurus.config.ts`
          branch: docs/version-${{ github.ref_name }}
          base: main
          delete-branch: true
          labels: docs,automation
          add-paths: |
            docs-site/docusaurus.config.ts
            docs-site/versions.json
            docs-site/versioned_docs/**
            docs-site/versioned_sidebars/**
